# 건강 데이터 연동 조치 결과 보고서

본 문서에서는 피트니스 앱의 핵심 기능인 **걸음 수 측정**과 **수면 시간 가져오기(삼성 헬스 연동)**에 대해 발생했던 이슈와, 이를 어떻게 해결(조치)했는지에 대한 최종 내역을 정리합니다.

---

## 1. 걸음 수 측정 기능 연계 조치 결과

### 🛑 초기 접근 및 문제점

- **초기 구현**: Гугл의 `Health Connect API`를 활용하여 삼성 헬스의 `StepsRecord`를 연동해 걸음 수를 가져오려 시도했습니다.
- **이슈 발생**: 앱의 권한(읽기 허용)만으로는 0에서 숫자가 올라가지 않는 문제가 지속적으로 발생했습니다. 삼성 헬스 자체에서 Health Connect로 데이터를 밀어넣어 주는 **"쓰기" 권한 세팅이 기기마다 파편화**되어 있으며 동기화 지연 문제가 잦아 사용자 경험이 매우 떨어지는 원인이 되었습니다.

### ✅ 최종 해결 방안 (단독 센서 직접 측정 방식 도입)

- **1. 호환성 및 속도 해결**: 삼성 헬스나 Health Connect를 거치지 않고, 스마트폰 기기 자체에 내장된 **하드웨어 센서(`Sensor.TYPE_STEP_COUNTER`)를 직접 읽어오는 Pedometer(만보기) 방식**으로 구조를 완전히 뜯어고쳤습니다.
- **2. 권한 변경**: 기존 Health Connect 기반 권한 대신, 안드로이드 10 이상의 필수 OS 권한인 **`ACTIVITY_RECOGNITION(신체 활동 데이터 액세스)`** 권한 기반으로 변경했습니다. 앱 시작 시 이 권한만 허용하면 딜레이 없이 1:1로 실시간 걸음 수가 반영됩니다.
- **3. 데이터 영구 보전**: 스마트폰을 재부팅하거나 자정이 지날 때마다 데이터가 꼬이는 기본 센서의 단점을 보완하기 위해, `SharedPreferences`를 이용해 **오늘의 초기 걸음 수를 캐싱해 두고 차이값을 계산** 하도록 구현했습니다. 이를 통해 앱을 강제로 껐다 켜거나 백그라운드에 있어도 안전하게 걸음 수가 누적 측정됩니다!

---

## 2. 수면 시간 연계 (삼성 헬스 연동) 조치 결과

### 🛑 초기 접근 및 이슈

- **초기 구현**: `Health Connect API`의 `SleepSessionRecord`를 읽어오기 위해 `readRecords`로 다수의 분할된 수면 기록을 리스트로 받아온 뒤 앱 내에서 합산하는(Sum) 방식을 사용했습니다.
- **이슈 발견**: 중복된 시간대나 소스(기기 등)가 다를 경우 데이터가 겹치거나 누락되어 정확한 총 수면 시간을 계산하기에 번거로움과 오차가 존재할 위험이 있었습니다.

### ✅ 최종 해결 방안 (최신 Health Connect 집계형 API 적용)

- **1. 단일 집계 API 교체**: 앱 단말에서 직접 수면 데이터 파편을 더하지 않고, Health Connect 서버 측의 가장 최신 방식인 **통합 집계 API (`AggregateRequest`)**를 호출하는 구조로 변경했습니다. 구글 권장 방식대로 `SleepSessionRecord.SLEEP_DURATION_TOTAL`을 요청하여 정확하고 검증된 총합 수면 시간(Minutes)을 단 번에 반환받습니다.
- **2. 측정 시간 기준 개선**: 전날 저녁(18:00)부터 현재 시점까지의 시간 범위를 필터(`TimeRangeFilter`)로 지정해, 삼성 헬스(갤럭시 워치 등)에서 Health Connect로 자동 동기화된 "오늘의 전체 수면"만을 정확히 타겟팅해서 가져옵니다.
- **3. 피드백 UI 추가**: 카드를 터치할 때마다 즉시 데이터를 동기화하고 수면 데이터 새로고침 중이라는 상태 알림(Toast) 메시지를 뜨게 하여 직관성을 확보했습니다. (필수 권한이 꺼져 있는 경우 즉시 허용 화면(`PermissionsRationaleActivity`)으로 넘어가도록 분기 처리 완비)
